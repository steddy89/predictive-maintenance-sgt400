<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SGT-400 Predictive Maintenance Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'turbine-green': '#22c55e',
        'turbine-yellow': '#eab308',
        'turbine-orange': '#f97316',
        'turbine-red': '#ef4444',
        'dark-bg': '#0f172a',
        'dark-card': '#1e293b',
        'dark-border': '#334155',
      }
    }
  }
}
</script>
<style>
  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
  .glow-green { box-shadow: 0 0 15px rgba(34,197,94,0.3); }
  .glow-yellow { box-shadow: 0 0 15px rgba(234,179,8,0.3); }
  .glow-orange { box-shadow: 0 0 15px rgba(249,115,22,0.3); }
  .glow-red { box-shadow: 0 0 15px rgba(239,68,68,0.3); }
  .pulse-dot { animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
  .fade-in { animation: fadeIn 0.5s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Agent Chat Panel */
  .agent-panel { transition: transform 0.3s ease, opacity 0.3s ease; }
  .agent-panel.collapsed { transform: translateX(100%); opacity: 0; pointer-events: none; }
  .chat-msg { animation: chatIn 0.3s ease-out; }
  @keyframes chatIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .agent-badge { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
  .typing-dots span { animation: dotPulse 1.4s infinite; }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dotPulse { 0%,80%,100% { opacity: 0.3; } 40% { opacity: 1; } }
  .markdown-body h2 { font-size: 1.1rem; font-weight: 700; margin: 0.5rem 0 0.25rem; }
  .markdown-body h3 { font-size: 0.95rem; font-weight: 600; margin: 0.5rem 0 0.25rem; color: #94a3b8; }
  .markdown-body table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin: 0.5rem 0; }
  .markdown-body th, .markdown-body td { border: 1px solid #334155; padding: 4px 8px; text-align: left; }
  .markdown-body th { background: #1e293b; font-weight: 600; }
  .markdown-body ul, .markdown-body ol { padding-left: 1.25rem; margin: 0.25rem 0; }
  .markdown-body li { margin: 2px 0; font-size: 0.85rem; }
  .markdown-body strong { color: #e2e8f0; }
  .markdown-body p { margin: 0.25rem 0; font-size: 0.85rem; line-height: 1.5; }
</style>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen">

<!-- Header -->
<header class="bg-dark-card border-b border-dark-border px-6 py-4">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
      </div>
      <div>
        <h1 class="text-xl font-bold">SGT-400 Predictive Maintenance</h1>
        <p class="text-gray-400 text-sm">Siemens Gas Turbine Monitoring Dashboard</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <span id="riskBadge" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
      <button id="agentToggle" onclick="toggleAgentPanel()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-sm font-medium transition-colors" title="AI Agent Chat">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
        </svg>
        AI Agent
      </button>
      <div class="flex items-center gap-2">
        <div id="connDot" class="w-2 h-2 rounded-full bg-turbine-green pulse-dot"></div>
        <span id="connText" class="text-sm text-gray-400">Connected</span>
      </div>
      <span id="lastUpdate" class="text-xs text-gray-500"></span>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

  <!-- KPI Cards Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="kpiGrid">
    <!-- Health Score -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5 fade-in" id="kpiHealth">
      <div class="flex items-center justify-between mb-3">
        <span class="text-gray-400 text-sm font-medium">Health Score</span>
        <svg class="w-5 h-5 text-turbine-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
      </div>
      <div class="text-3xl font-bold" id="healthValue">--</div>
      <div class="w-full bg-gray-700 rounded-full h-2 mt-3">
        <div id="healthBar" class="h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
    <!-- Anomaly Score -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5 fade-in">
      <div class="flex items-center justify-between mb-3">
        <span class="text-gray-400 text-sm font-medium">Anomaly Score</span>
        <svg class="w-5 h-5 text-turbine-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
      </div>
      <div class="text-3xl font-bold" id="anomalyValue">--</div>
      <div class="text-sm mt-1" id="anomalyLabel"></div>
    </div>
    <!-- Fault Status -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5 fade-in">
      <div class="flex items-center justify-between mb-3">
        <span class="text-gray-400 text-sm font-medium">Fault Detection</span>
        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </div>
      <div class="text-3xl font-bold" id="faultValue">--</div>
      <div class="text-sm text-gray-400 mt-1">Real-time fault classifier</div>
    </div>
    <!-- Risk Level -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5 fade-in" id="kpiRisk">
      <div class="flex items-center justify-between mb-3">
        <span class="text-gray-400 text-sm font-medium">Risk Level</span>
        <svg class="w-5 h-5 text-turbine-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
      </div>
      <div class="text-3xl font-bold" id="riskValue">--</div>
      <div class="text-sm text-gray-400 mt-1" id="riskRecommendation"></div>
    </div>
  </div>

  <!-- Charts + Sensor Readings Row -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Trend Chart -->
    <div class="lg:col-span-2 bg-dark-card rounded-xl border border-dark-border p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Live Sensor Feed <span class="text-xs text-blue-400 ml-2 font-normal">● streaming every 2s</span></h2>
        <select id="sensorSelect" class="bg-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 border border-dark-border">
          <option value="temperature_c">Temperature (°C)</option>
          <option value="rpm">RPM</option>
          <option value="torque_nm">Torque (Nm)</option>
          <option value="vibration_mm_s">Vibration (mm/s)</option>
          <option value="power_output_mw">Power Output (MW)</option>
          <option value="fuel_flow_kg_s">Fuel Flow (kg/s)</option>
          <option value="air_pressure_kpa">Air Pressure (kPa)</option>
          <option value="exhaust_gas_temp_c">Exhaust Gas Temp (°C)</option>
          <option value="oil_temp_c">Oil Temp (°C)</option>
        </select>
      </div>
      <div style="position: relative; width: 100%; height: 260px;">
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <!-- Live Sensor Readings -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5">
      <h2 class="text-lg font-semibold mb-4">Live Sensor Readings</h2>
      <div class="space-y-3" id="sensorList"></div>
    </div>
  </div>

  <!-- Alerts + Maintenance Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- Active Alerts -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Active Alerts</h2>
        <span id="alertCount" class="bg-turbine-red/20 text-turbine-red px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
      </div>
      <div class="space-y-3" id="alertList">
        <p class="text-gray-500 text-sm">No active alerts</p>
      </div>
    </div>

    <!-- Data Stream + Agent Info -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-5">
      <h2 class="text-lg font-semibold mb-4">Dataset Stream</h2>
      <div class="space-y-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm">Progress through dataset</span>
            <span class="text-xs text-gray-500 font-mono" id="dataProgressText">-- / --</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div id="dataProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
          <div class="text-sm font-medium text-gray-300 mb-1">About</div>
          <div class="text-sm text-gray-400">Streaming 1,386 real sensor readings from the gas turbine fault detection dataset at 2-second intervals. Red dots on the chart indicate detected faults.</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-xs text-gray-400">Interval</div>
            <div class="text-lg font-bold text-blue-400">2s</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-xs text-gray-400">Chart Window</div>
            <div class="text-lg font-bold text-gray-200">60 pts</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Architecture Card -->
  <div class="bg-dark-card rounded-xl border border-dark-border p-5">
    <div class="flex items-center gap-3 mb-4">
      <div class="agent-badge w-8 h-8 rounded-lg flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold">Azure AI Foundry Agent System</h2>
        <p class="text-gray-400 text-xs">Multi-agent architecture with Fabric Data Agent</p>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="bg-gray-800/50 rounded-lg p-3 border border-indigo-500/20">
        <div class="flex items-center gap-2 mb-1">
          <div class="w-2 h-2 rounded-full bg-indigo-400"></div>
          <span class="text-sm font-medium text-indigo-300">Orchestrator Agent</span>
        </div>
        <p class="text-xs text-gray-400">Routes queries to specialist agents, synthesises responses, manages conversation state</p>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3 border border-blue-500/20">
        <div class="flex items-center gap-2 mb-1">
          <div class="w-2 h-2 rounded-full bg-blue-400"></div>
          <span class="text-sm font-medium text-blue-300">Fabric Data Agent</span>
        </div>
        <p class="text-xs text-gray-400">5 tools: sensor query, statistics, anomaly detection, fault analysis, correlation</p>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3 border border-purple-500/20">
        <div class="flex items-center gap-2 mb-1">
          <div class="w-2 h-2 rounded-full bg-purple-400"></div>
          <span class="text-sm font-medium text-purple-300">Diagnostic Agent</span>
        </div>
        <p class="text-xs text-gray-400">Chain-of-thought reasoning: health assessment, root cause analysis, recommendations</p>
      </div>
    </div>
  </div>

  <!-- API Documentation Link -->
  <div class="bg-dark-card rounded-xl border border-dark-border p-4 flex items-center justify-between">
    <div>
      <span class="text-gray-400 text-sm">API Documentation</span>
      <span class="text-gray-500 text-xs ml-2">Interactive Swagger UI for all endpoints · Agent API at /api/v1/agent/*</span>
    </div>
    <a href="/docs" target="_blank" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
      Open API Docs →
    </a>
  </div>
</main>

<!-- ═══════════════════════════════════════════════════════════════ -->
<!-- Agent Chat Panel (slide-in from right)                         -->
<!-- ═══════════════════════════════════════════════════════════════ -->
<div id="agentPanel" class="agent-panel collapsed fixed top-0 right-0 h-full w-full sm:w-[420px] bg-dark-card border-l border-dark-border z-50 flex flex-col shadow-2xl">
  <!-- Panel Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-dark-border bg-gradient-to-r from-indigo-600/20 to-purple-600/20">
    <div class="flex items-center gap-3">
      <div class="agent-badge w-8 h-8 rounded-lg flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
        </svg>
      </div>
      <div>
        <h3 class="font-semibold text-sm">AI Diagnostic Agent</h3>
        <p class="text-[10px] text-gray-400">Azure AI Foundry · Fabric Data Agent</p>
      </div>
    </div>
    <button onclick="toggleAgentPanel()" class="p-1.5 hover:bg-gray-700 rounded-lg transition-colors">
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- Chat Messages -->
  <div id="chatMessages" class="flex-1 overflow-y-auto px-4 py-3 space-y-3">
    <!-- Welcome message -->
    <div class="chat-msg">
      <div class="flex items-start gap-2">
        <div class="agent-badge w-6 h-6 rounded-md flex-shrink-0 flex items-center justify-center mt-0.5">
          <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <div class="bg-gray-800/60 rounded-lg rounded-tl-none p-3 max-w-[90%]">
          <p class="text-sm text-gray-300">Hi! I'm your <strong class="text-indigo-300">SGT-400 Diagnostic Agent</strong> powered by Azure AI Foundry.</p>
          <p class="text-sm text-gray-400 mt-1">I can analyse sensor data from Microsoft Fabric, diagnose faults, and recommend maintenance actions. Try asking:</p>
        </div>
      </div>
    </div>
    <!-- Suggested Prompts -->
    <div id="suggestedPrompts" class="flex flex-wrap gap-2 pl-8">
    </div>
  </div>

  <!-- Agent Tool Trace (collapsible) -->
  <div id="toolTrace" class="hidden border-t border-dark-border">
    <button onclick="document.getElementById('toolTraceBody').classList.toggle('hidden')" class="w-full flex items-center justify-between px-4 py-2 text-xs text-gray-400 hover:bg-gray-800/50">
      <span>&#128295; Agent Tool Trace</span>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div id="toolTraceBody" class="hidden px-4 pb-2 max-h-32 overflow-y-auto">
    </div>
  </div>

  <!-- Chat Input -->
  <div class="border-t border-dark-border px-4 py-3">
    <form id="chatForm" onsubmit="sendAgentMessage(event)" class="flex items-center gap-2">
      <input
        id="chatInput"
        type="text"
        placeholder="Ask the diagnostic agent..."
        class="flex-1 bg-gray-800 text-gray-200 text-sm rounded-lg px-3 py-2.5 border border-dark-border focus:border-indigo-500 focus:outline-none placeholder-gray-500"
        autocomplete="off"
      />
      <button type="submit" id="chatSendBtn" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-2.5 rounded-lg transition-colors flex-shrink-0">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
      </button>
    </form>
  </div>
</div>

<footer class="border-t border-dark-border mt-8 py-4 text-center text-gray-500 text-xs">
  SGT-400 Predictive Maintenance System v1.0.0 &middot; Powered by Microsoft Fabric + Azure AI Foundry &middot; Multi-Agent Architecture
</footer>

<script>
const API = '';  // Same origin
let trendChart = null;

// ── Configuration ──────────────────────────────────────────────
const LIVE_INTERVAL_MS = 2000;    // poll every 2 seconds
const MAX_CHART_POINTS = 60;      // keep 60 data points visible (120s window)

// ── State ──────────────────────────────────────────────────────
let liveHistory = [];             // ring buffer of recent readings
let selectedSensor = 'temperature_c';

// ── Utility Functions ──────────────────────────────────────────
function riskColor(level) {
  const m = { LOW: 'turbine-green', MEDIUM: 'turbine-yellow', HIGH: 'turbine-orange', CRITICAL: 'turbine-red' };
  return m[level] || 'gray-400';
}
function riskGlow(level) {
  const m = { LOW: 'glow-green', MEDIUM: 'glow-yellow', HIGH: 'glow-orange', CRITICAL: 'glow-red' };
  return m[level] || '';
}
function severityBg(sev) {
  const m = { CRITICAL: 'bg-red-500/20 border-red-500/30', WARNING: 'bg-yellow-500/20 border-yellow-500/30', INFO: 'bg-blue-500/20 border-blue-500/30' };
  return m[sev] || 'bg-gray-500/20 border-gray-500/30';
}
function fmtTime(ts) {
  const d = new Date(ts);
  return d.getHours().toString().padStart(2,'0') + ':' +
         d.getMinutes().toString().padStart(2,'0') + ':' +
         d.getSeconds().toString().padStart(2,'0');
}

// ── Fetch helper ───────────────────────────────────────────────
async function api(path) {
  const res = await fetch(API + path);
  if (!res.ok) throw new Error(`${res.status}`);
  return res.json();
}

// ── Live Data Feed — single source of truth ────────────────────
async function fetchLiveReading() {
  try {
    const resp = await api('/api/v1/turbine/live');
    const d = resp.data;

    // Push into ring buffer
    liveHistory.push(d);
    if (liveHistory.length > MAX_CHART_POINTS) liveHistory.shift();

    // Update everything from this single reading
    updateKPIsFromLive(d);
    updateSensorPanel(d);
    updateChartFromLive();
    updateConnectionStatus(true);
    updateProgressBar(d);
  } catch (err) {
    console.error('Live feed error:', err);
    updateConnectionStatus(false);
  }
}

// ── KPI Cards ──────────────────────────────────────────────────
function updateKPIsFromLive(d) {
  // Health Score
  const health = d.health_score;
  document.getElementById('healthValue').textContent = health.toFixed(1) + '%';
  const hbar = document.getElementById('healthBar');
  hbar.style.width = health + '%';
  hbar.className = 'h-2 rounded-full transition-all duration-500 ' +
    (health >= 80 ? 'bg-turbine-green' : health >= 60 ? 'bg-turbine-yellow' : health >= 40 ? 'bg-turbine-orange' : 'bg-turbine-red');

  // Anomaly Score
  const aScore = d.anomaly_score;
  document.getElementById('anomalyValue').textContent = (aScore * 100).toFixed(1) + '%';
  const aLabel = document.getElementById('anomalyLabel');
  if (aScore > 0.7) { aLabel.textContent = 'CRITICAL'; aLabel.className = 'text-sm mt-1 text-turbine-red font-semibold'; }
  else if (aScore > 0.4) { aLabel.textContent = 'WARNING'; aLabel.className = 'text-sm mt-1 text-turbine-yellow font-semibold'; }
  else { aLabel.textContent = 'NORMAL'; aLabel.className = 'text-sm mt-1 text-turbine-green font-semibold'; }

  // Fault indicator
  const faultBadge = d.fault === 1 ? '⚠ FAULT' : '✓ NORMAL';
  document.getElementById('faultValue').textContent = faultBadge;
  document.getElementById('faultValue').className = 'text-3xl font-bold ' +
    (d.fault === 1 ? 'text-turbine-red' : 'text-turbine-green');

  // Risk
  const risk = d.risk_level;
  document.getElementById('riskValue').textContent = risk;
  document.getElementById('riskValue').className = 'text-3xl font-bold text-' + riskColor(risk);

  // Header badge
  const badge = document.getElementById('riskBadge');
  badge.textContent = risk;
  badge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-' + riskColor(risk) + '/20 text-' + riskColor(risk);

  // Timestamp
  document.getElementById('lastUpdate').textContent = 'Updated ' + fmtTime(d.timestamp);
}

// ── Sensor Readings Panel ──────────────────────────────────────
function updateSensorPanel(d) {
  const sensors = [
    { name: 'Temperature', value: d.temperature_c, unit: '°C', max: 1100 },
    { name: 'RPM', value: d.rpm, unit: '', max: 17000 },
    { name: 'Torque', value: d.torque_nm, unit: 'Nm', max: 4500 },
    { name: 'Vibration', value: d.vibration_mm_s, unit: 'mm/s', max: 5 },
    { name: 'Power Output', value: d.power_output_mw, unit: 'MW', max: 140 },
    { name: 'Fuel Flow', value: d.fuel_flow_kg_s, unit: 'kg/s', max: 4 },
    { name: 'Air Pressure', value: d.air_pressure_kpa, unit: 'kPa', max: 220 },
    { name: 'Exhaust Gas Temp', value: d.exhaust_gas_temp_c, unit: '°C', max: 600 },
    { name: 'Oil Temp', value: d.oil_temp_c, unit: '°C', max: 160 },
  ];
  document.getElementById('sensorList').innerHTML = sensors.map(s => {
    const pct = Math.min(100, (s.value / s.max) * 100);
    const barColor = pct > 90 ? 'bg-turbine-red' : pct > 75 ? 'bg-turbine-orange' : pct > 60 ? 'bg-turbine-yellow' : 'bg-blue-500';
    return `
      <div class="py-2 border-b border-dark-border last:border-0">
        <div class="flex items-center justify-between mb-1">
          <span class="text-gray-400 text-sm">${s.name}</span>
          <span class="font-mono font-semibold text-sm">${s.value.toFixed(2)} ${s.unit}</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-1.5">
          <div class="${barColor} h-1.5 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
        </div>
      </div>`;
  }).join('');
}

// ── Live Trend Chart ───────────────────────────────────────────
function updateChartFromLive() {
  const labels = liveHistory.map(p => fmtTime(p.timestamp));
  const values = liveHistory.map(p => p[selectedSensor] ?? 0);
  const prettyName = selectedSensor.replace(/_/g, ' ');

  // Fault markers — highlight points where fault == 1
  const pointColors = liveHistory.map(p =>
    p.fault === 1 ? '#ef4444' : '#3b82f6'
  );
  const pointRadii = liveHistory.map(p =>
    p.fault === 1 ? 5 : 1.5
  );

  if (trendChart) {
    trendChart.data.labels = labels;
    trendChart.data.datasets[0].data = values;
    trendChart.data.datasets[0].label = prettyName;
    trendChart.data.datasets[0].pointBackgroundColor = pointColors;
    trendChart.data.datasets[0].pointRadius = pointRadii;
    trendChart.update('active');
  } else {
    const ctx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: prettyName,
          data: values,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.08)',
          fill: true,
          tension: 0.35,
          pointRadius: pointRadii,
          pointBackgroundColor: pointColors,
          pointHoverRadius: 6,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 400, easing: 'easeOutQuart' },
        plugins: {
          legend: { labels: { color: '#94a3b8' } },
          tooltip: {
            mode: 'index', intersect: false,
            backgroundColor: '#1e293b', borderColor: '#334155', borderWidth: 1,
            callbacks: {
              afterLabel: function(ctx) {
                const idx = ctx.dataIndex;
                const pt = liveHistory[idx];
                return pt && pt.fault === 1 ? '⚠ FAULT DETECTED' : '';
              }
            }
          },
        },
        scales: {
          x: { ticks: { color: '#64748b', maxTicksLimit: 10, maxRotation: 0 }, grid: { color: 'rgba(51,65,85,0.3)' } },
          y: { ticks: { color: '#64748b' }, grid: { color: 'rgba(51,65,85,0.3)' } }
        },
        interaction: { intersect: false, mode: 'index' },
      }
    });
  }
}

// ── Progress bar showing position in dataset ───────────────────
function updateProgressBar(d) {
  const pct = ((d.index / d.total_rows) * 100).toFixed(1);
  document.getElementById('dataProgress').style.width = pct + '%';
  document.getElementById('dataProgressText').textContent = `Row ${d.index} / ${d.total_rows}`;
}

// ── Connection indicator ───────────────────────────────────────
function updateConnectionStatus(ok) {
  document.getElementById('connDot').className = ok
    ? 'w-2 h-2 rounded-full bg-turbine-green pulse-dot'
    : 'w-2 h-2 rounded-full bg-turbine-red';
  document.getElementById('connText').textContent = ok ? 'Live · 2s' : 'Disconnected';
}

// ── Alerts (less frequent polling) ─────────────────────────────
async function updateAlerts() {
  try {
    const data = await api('/api/v1/alerts/');
    const alerts = data.alerts || [];
    const active = alerts.filter(a => !a.resolved);

    document.getElementById('alertCount').textContent = active.length;

    if (active.length === 0) {
      document.getElementById('alertList').innerHTML = '<p class="text-gray-500 text-sm">No active alerts — system nominal</p>';
      return;
    }

    document.getElementById('alertList').innerHTML = active.slice(0, 8).map(a => `
      <div class="border rounded-lg p-3 ${severityBg(a.severity)}">
        <div class="flex items-center justify-between">
          <span class="text-xs font-semibold px-2 py-0.5 rounded ${a.severity === 'CRITICAL' ? 'bg-red-500/30 text-red-300' : 'bg-yellow-500/30 text-yellow-300'}">${a.severity}</span>
          <span class="text-xs text-gray-400">${fmtTime(a.timestamp)}</span>
        </div>
        <div class="mt-2 text-sm font-medium">${a.description}</div>
        <div class="mt-1 text-xs text-gray-400">${a.alarm_code} · Value: ${a.sensor_value} / Threshold: ${a.threshold}</div>
      </div>
    `).join('');
  } catch (err) {
    console.error('Alert update failed:', err);
  }
}

// ── Sensor selector change ─────────────────────────────────────
document.getElementById('sensorSelect').addEventListener('change', (e) => {
  selectedSensor = e.target.value;
  updateChartFromLive();
});

// ── Init & polling ─────────────────────────────────────────────
async function init() {
  // Kick off first reading immediately
  await fetchLiveReading();
  await updateAlerts();

  // Live data every 2 seconds
  setInterval(fetchLiveReading, LIVE_INTERVAL_MS);

  // Alerts every 15 seconds
  setInterval(updateAlerts, 15000);

  // Load agent suggested prompts
  loadSuggestedPrompts();
}

// ═══════════════════════════════════════════════════════════════
// Agent Chat System
// ═══════════════════════════════════════════════════════════════

let agentPanelOpen = false;

function toggleAgentPanel() {
  const panel = document.getElementById('agentPanel');
  agentPanelOpen = !agentPanelOpen;
  if (agentPanelOpen) {
    panel.classList.remove('collapsed');
    document.getElementById('chatInput').focus();
  } else {
    panel.classList.add('collapsed');
  }
}

async function loadSuggestedPrompts() {
  try {
    const data = await api('/api/v1/agent/status');
    const prompts = data.suggested_prompts || [];
    const container = document.getElementById('suggestedPrompts');
    container.innerHTML = prompts.map(p =>
      `<button onclick="sendSuggested('${p.text.replace(/'/g, "\\'")}')" class="text-xs bg-gray-800 hover:bg-indigo-600/30 text-gray-300 hover:text-indigo-200 border border-dark-border hover:border-indigo-500/40 rounded-full px-3 py-1.5 transition-colors">${p.text}</button>`
    ).join('');
  } catch (err) {
    console.log('Agent status not available yet');
  }
}

function sendSuggested(text) {
  document.getElementById('chatInput').value = text;
  sendAgentMessage(new Event('submit'));
}

async function sendAgentMessage(e) {
  e.preventDefault();
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  input.value = '';
  const sendBtn = document.getElementById('chatSendBtn');
  sendBtn.disabled = true;
  input.disabled = true;

  // Hide suggested prompts
  document.getElementById('suggestedPrompts').style.display = 'none';

  // Add user message
  appendChatMessage('user', message);

  // Show typing indicator
  const typingId = showTypingIndicator();

  try {
    const res = await fetch(API + '/api/v1/agent/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message }),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // Remove typing indicator
    removeTypingIndicator(typingId);

    // Show agent response
    appendChatMessage('agent', data.message, data);

    // Show tool trace
    showToolTrace(data);

  } catch (err) {
    removeTypingIndicator(typingId);
    appendChatMessage('agent', 'Sorry, I encountered an error. Please try again.', null);
    console.error('Agent error:', err);
  }

  sendBtn.disabled = false;
  input.disabled = false;
  input.focus();
}

function appendChatMessage(role, content, meta) {
  const container = document.getElementById('chatMessages');

  const div = document.createElement('div');
  div.className = 'chat-msg';

  if (role === 'user') {
    div.innerHTML = `
      <div class="flex justify-end">
        <div class="bg-indigo-600/30 rounded-lg rounded-tr-none p-3 max-w-[85%]">
          <p class="text-sm text-gray-200">${escapeHtml(content)}</p>
        </div>
      </div>`;
  } else {
    const riskBadge = meta && meta.risk_level
      ? `<span class="inline-block text-[10px] font-bold px-1.5 py-0.5 rounded ${riskBadgeClass(meta.risk_level)} ml-2">${meta.risk_level}</span>`
      : '';
    const agentsUsed = meta && meta.agents_used
      ? `<div class="flex items-center gap-1 mt-2">${meta.agents_used.map(a => `<span class="text-[10px] bg-gray-700 text-gray-400 px-1.5 py-0.5 rounded">${a}</span>`).join('')}<span class="text-[10px] text-gray-500 ml-1">${meta.processing_time_s}s</span></div>`
      : '';

    div.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="agent-badge w-6 h-6 rounded-md flex-shrink-0 flex items-center justify-center mt-0.5">
          <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <div class="bg-gray-800/60 rounded-lg rounded-tl-none p-3 max-w-[90%]">
          ${riskBadge}
          <div class="markdown-body text-sm text-gray-300 mt-1">${renderMarkdown(content)}</div>
          ${agentsUsed}
        </div>
      </div>`;
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
  const id = 'typing-' + Date.now();
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.id = id;
  div.className = 'chat-msg';
  div.innerHTML = `
    <div class="flex items-start gap-2">
      <div class="agent-badge w-6 h-6 rounded-md flex-shrink-0 flex items-center justify-center mt-0.5">
        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      </div>
      <div class="bg-gray-800/60 rounded-lg rounded-tl-none px-4 py-3">
        <div class="typing-dots flex gap-1">
          <span class="w-2 h-2 bg-indigo-400 rounded-full"></span>
          <span class="w-2 h-2 bg-indigo-400 rounded-full"></span>
          <span class="w-2 h-2 bg-indigo-400 rounded-full"></span>
        </div>
      </div>
    </div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return id;
}

function removeTypingIndicator(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function showToolTrace(data) {
  if (!data || !data.metadata) return;
  const traceDiv = document.getElementById('toolTrace');
  const body = document.getElementById('toolTraceBody');
  traceDiv.classList.remove('hidden');

  const tools = data.metadata.tools_invoked || [];
  const workflow = data.metadata.workflow || 'unknown';

  body.innerHTML = `
    <div class="space-y-1 text-xs text-gray-400">
      <div><span class="text-gray-500">Workflow:</span> <span class="text-indigo-300">${workflow}</span></div>
      <div><span class="text-gray-500">Agent:</span> ${data.metadata.agent || '?'}</div>
      <div><span class="text-gray-500">Data Agent:</span> ${data.metadata.fabric_data_agent || '?'}</div>
      ${tools.length ? '<div class="text-gray-500 mt-1">Tools invoked:</div>' : ''}
      ${tools.map(t => `<div class="ml-2 font-mono text-blue-300">&#9654; ${t}</div>`).join('')}
    </div>`;
}

function riskBadgeClass(level) {
  const m = {
    LOW: 'bg-green-500/20 text-green-300',
    MEDIUM: 'bg-yellow-500/20 text-yellow-300',
    HIGH: 'bg-orange-500/20 text-orange-300',
    CRITICAL: 'bg-red-500/20 text-red-300',
  };
  return m[level] || 'bg-gray-500/20 text-gray-300';
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Simple markdown-to-HTML (handles **, ##, ###, tables, lists)
function renderMarkdown(md) {
  if (!md) return '';
  let html = escapeHtml(md);
  // Headers
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Tables
  html = html.replace(/^\|(.+)\|$/gm, (match) => {
    const cells = match.split('|').filter(c => c.trim());
    if (cells.every(c => /^[-\s:]+$/.test(c.trim()))) return ''; // separator row
    const tag = cells.some(c => /^[-\s:]+$/.test(c.trim())) ? 'td' : 'td';
    return '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
  });
  html = html.replace(/(<tr>.*<\/tr>\n?)+/g, '<table>$&</table>');
  // List items
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  // Line breaks
  html = html.replace(/\n\n/g, '</p><p>');
  html = html.replace(/\n/g, '<br>');
  return '<p>' + html + '</p>';
}

init();
</script>
</body>
</html>
